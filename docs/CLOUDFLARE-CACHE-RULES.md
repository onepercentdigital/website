# Cloudflare Cache Rules

This document explains the Cloudflare cache rules configured for the One Percent Digital website.

## Overview

The site uses TanStack Start with Cloudflare Workers for server-side rendering. Since no cache headers are set in application code, Cloudflare Cache Rules control all caching behavior.

**Cache Rules Location:** Cloudflare Dashboard > Caching > Cache Rules

## Cache Rules (in priority order)

Rules are evaluated top-to-bottom. The first matching rule applies.

---

### Rule 1: Bypass cache for TanStack server functions

**Expression:**
```
(starts_with(http.request.uri.path, "/_server"))
```

**Action:** Bypass cache

**Why:** TanStack Start uses `/_server` paths for server function calls during SSR hydration and data fetching. These requests are dynamic and must never be cached, as they return user-specific or real-time data from Convex.

---

### Rule 2: Cache immutable build assets (1 year)

**Expression:**
```
(starts_with(http.request.uri.path, "/assets/"))
```

**Action:** Cache with TTL
- Edge TTL: 31536000 seconds (1 year)
- Browser TTL: 31536000 seconds (1 year)

**Why:** All files under `/assets/` are Vite build outputs with content hashes in their filenames (e.g., `main-Ln-9Q-Up.js`, `router-Dfs9RUU9.css`). When code changes, the hash changes, creating a new URL. This makes aggressive caching safe - users always get fresh content because the URL itself changes on updates.

**Matches:**
- JavaScript bundles: `/assets/main-*.js`, `/assets/index-*.js`
- CSS stylesheets: `/assets/router-*.css`, `/assets/styles-*.css`
- Fonts: `/assets/plus-jakarta-sans-*.woff2`
- Route chunks: `/assets/seo-*.js`, `/assets/blog-*.js`, etc.

---

### Rule 3: Cache SEO files (1 hour)

**Expression:**
```
(http.request.uri.path in {"/robots.txt" "/sitemap.xml"})
```

**Action:** Cache with TTL
- Edge TTL: 3600 seconds (1 hour)
- Browser TTL: 3600 seconds (1 hour)

**Why:** These files are regenerated on each build (sitemap is generated by `scripts/generate-sitemap.ts`). A 1-hour TTL ensures:
- Search engine crawlers get reasonably fresh sitemaps
- Edge caching reduces Worker invocations
- Updates propagate within an hour of deployment

---

### Rule 4: Cache static public files (30 days)

**Expression:**
```
(http.request.uri.path in {"/favicon.ico" "/logo.svg" "/logo192.png" "/logo512.png" "/manifest.json"})
```

**Action:** Cache with TTL
- Edge TTL: 2592000 seconds (30 days)
- Browser TTL: 2592000 seconds (30 days)

**Why:** These files in `/public/` are copied as-is to the build output without content hashes. They rarely change (logo, favicon, PWA manifest), so 30 days is a good balance between caching efficiency and update propagation.

**Note:** If you update any of these files, use Cloudflare's "Purge Cache" feature to clear them immediately.

---

### Rule 5: Cache HTML pages (1 minute)

**Expression:**
```
(not starts_with(http.request.uri.path, "/assets/") and not starts_with(http.request.uri.path, "/_server") and not http.request.uri.path in {"/robots.txt" "/sitemap.xml" "/favicon.ico" "/logo.svg" "/logo192.png" "/logo512.png" "/manifest.json"})
```

**Action:** Cache with TTL
- Edge TTL: 60 seconds (1 minute)
- Browser TTL: 60 seconds (1 minute)

**Why:** HTML pages are server-side rendered by TanStack Start. A short cache:
- Reduces Cloudflare Worker invocations (cost savings)
- Benefits from Tiered Cache (edge nodes share cached responses)
- Ensures content updates appear within 1 minute

**Matches:**
- Homepage: `/`
- Service pages: `/seo`, `/geo`, `/pm`
- Blog pages: `/blog`, `/blog/[slug]`
- Solutions pages: `/solutions`, `/solutions/[industry]`
- All other HTML routes

---

## Architecture Notes

### Why no `/api/` rule?

This site has no REST API endpoints. All data fetching uses:
- **Convex:** Real-time database accessed via WebSocket connections (not HTTP)
- **Server functions:** TanStack Start's `/_server` paths (covered by Rule 1)

### Why no `/_build/` path?

Vite outputs build assets to `/assets/`, not `/_build/`. The `/_build/` path was from an earlier recommendation that didn't match this codebase.

### Tiered Cache Benefit

With Tiered Cache enabled (included in free plan), Cloudflare's edge nodes share cached responses. The 1-minute HTML cache means:
1. First request to an edge node: Worker runs, response cached
2. Next 60 seconds: All requests to ANY edge node can use cached response
3. After 60 seconds: One edge node revalidates, shares with others

This significantly reduces Worker invocations for popular pages.

---

## Verifying Cache Behavior

Check cache status via response headers:

```bash
curl -I https://onepercentseo.com/assets/main-Ln-9Q-Up.js
# Look for: cf-cache-status: HIT

curl -I https://onepercentseo.com/
# Look for: cf-cache-status: HIT (after first request)

curl -I https://onepercentseo.com/_server/...
# Look for: cf-cache-status: BYPASS
```

**Cache status values:**
- `HIT` - Served from cache
- `MISS` - Not in cache, fetched from origin
- `BYPASS` - Cache intentionally skipped
- `DYNAMIC` - Not cacheable (no rule matched)

---

## Updating These Rules

1. Log into Cloudflare Dashboard
2. Select the domain
3. Navigate to: Caching > Cache Rules
4. Edit rules in the order shown above
5. Deploy changes (instant, no purge needed for rule changes)

To force-update cached content after deployment:
1. Caching > Configuration > Purge Cache
2. Choose "Purge Everything" or enter specific URLs
